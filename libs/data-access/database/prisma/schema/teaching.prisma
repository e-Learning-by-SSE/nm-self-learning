model Student {
    userId                     String                @unique
    username                   String                @id
    completedLessons           CompletedLesson[]
    enrollments                Enrollment[]
    customLearningLocations    LearningLocation[]
    quizAttempts               QuizAttempt[]
    user                       User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
    learningDiaryEntrys        LearningDiaryPage[]
    personalLearningTechniques LearningTechnique[]
    learningTechniqueRatings   TechniqueRating[]
    learningGoals              LearningGoal[]
    generatedLessonPaths       GeneratedLessonPath[]
    received                   Skill[]               @relation("StudentToSkill")
}

model Author {
    id                  Int                   @id @default(autoincrement())
    username            String                @unique
    displayName         String
    slug                String                @unique
    imgUrl              String?
    user                User                  @relation(fields: [username], references: [name], onDelete: Cascade)
    specializationAdmin SpecializationAdmin[]
    subjectAdmin        SubjectAdmin[]
    courses             Course[]              @relation("AuthorToCourse")
    lessons             Lesson[]              @relation("AuthorToLesson")
    teams               Team[]                @relation("AuthorToTeam")
    skills              Skill[]
    dynCourse           DynCourse[]           @relation("AuthorToDynCourse")
}

model SubjectAdmin {
    subjectId String
    username  String
    subject   Subject @relation(fields: [subjectId], references: [subjectId], onDelete: Cascade)
    author    Author  @relation(fields: [username], references: [username], onDelete: Cascade)

    @@id([subjectId, username])
}

model SpecializationAdmin {
    specializationId String
    username         String
    specialization   Specialization @relation(fields: [specializationId], references: [specializationId], onDelete: Cascade)
    author           Author         @relation(fields: [username], references: [username], onDelete: Cascade)

    @@id([specializationId, username])
}

model Team {
    teamId      Int      @id @default(autoincrement())
    slug        String   @unique
    name        String
    description String?
    imgUrl      String?
    authors     Author[] @relation("AuthorToTeam")
}

model Subject {
    subjectId       String           @id
    slug            String           @unique
    title           String
    subtitle        String
    imgUrlBanner    String?
    cardImgUrl      String?
    courses         Course[]
    specializations Specialization[]
    subjectAdmin    SubjectAdmin[]
    dynCourse       DynCourse[]
}

model Specialization {
    specializationId    String                @id
    slug                String                @unique
    title               String
    subtitle            String
    imgUrlBanner        String?
    cardImgUrl          String?
    subjectId           String
    subject             Subject               @relation(fields: [subjectId], references: [subjectId], onDelete: Cascade)
    specializationAdmin SpecializationAdmin[]
    courses             Course[]              @relation("CourseToSpecialization")
    dynCourses          DynCourse[]           @relation("DynCourseToSpecialization")
}

model Course {
    courseId             String              @id
    slug                 String              @unique
    title                String
    subtitle             String
    description          String?
    imgUrl               String?
    content              Json
    meta                 Json
    createdAt            DateTime            @default(now())
    updatedAt            DateTime            @updatedAt
    subjectId            String?
    completions          CompletedLesson[]
    subject              Subject?            @relation(fields: [subjectId], references: [subjectId])
    enrollments          Enrollment[]
    authors              Author[]            @relation("AuthorToCourse")
    specializations      Specialization[]    @relation("CourseToSpecialization")
    learningDiaryEntries LearningDiaryPage[]
    requires             Skill[]             @relation("courseRequiredSkills")
    provides             Skill[]             @relation("courseProvidedSkills")
}

model DynCourse {
    courseId             String                @id
    slug                 String                @unique
    title                String
    subtitle             String
    courseVersion        String
    description          String?
    imgUrl               String?
    teachingGoals        Skill[]               @relation("DynCourseTeachingGoals")
    requirements         Skill[]               @relation("DynCourseRequirements")
    meta                 Json
    createdAt            DateTime              @default(now())
    updatedAt            DateTime              @updatedAt
    subjectId            String?
    enrollments          Enrollment[]
    completions          CompletedLesson[]
    authors              Author[]              @relation("AuthorToDynCourse")
    subject              Subject?              @relation(fields: [subjectId], references: [subjectId])
    specializations      Specialization[]      @relation("DynCourseToSpecialization")
    generatedLessonPaths GeneratedLessonPath[]
}

model GeneratedLessonPath {
    lessonPathId  String    @id @default(cuid())
    content       Json
    meta          Json
    courseVersion String
    username      String
    slug          String    @unique
    courseId      String
    createdAt     DateTime  @default(now())
    updatedAt     DateTime  @updatedAt
    student       Student   @relation(fields: [username], references: [username], onDelete: Cascade)
    course        DynCourse @relation(fields: [courseId], references: [courseId], onDelete: Cascade)
}

model Enrollment {
    id                 String           @id @default(uuid())
    status             EnrollmentStatus
    progress           Int              @default(0)
    createdAt          DateTime         @default(now())
    lastProgressUpdate DateTime         @default(now())
    completedAt        DateTime?
    courseId           String?
    dynCourseId        String?
    username           String
    course             Course?           @relation(fields: [courseId], references: [courseId], onDelete: Cascade)
    student            Student          @relation(fields: [username], references: [username], onDelete: Cascade)
    dynCourse          DynCourse?       @relation(fields: [dynCourseId], references: [courseId], onDelete: Cascade)

    @@unique([courseId, username])
    @@unique([dynCourseId, username])
}

enum LessonType {
    TRADITIONAL
    SELF_REGULATED
}

model Lesson {
    lessonId              String            @id
    slug                  String            @unique
    title                 String
    subtitle              String?
    description           String?
    imgUrl                String?
    content               Json
    quiz                  Json?
    meta                  Json
    createdAt             DateTime          @default(now())
    updatedAt             DateTime          @updatedAt
    completions           CompletedLesson[]
    quizAttempts          QuizAttempt[]
    authors               Author[]          @relation("AuthorToLesson")
    license               License?          @relation(fields: [licenseId], references: [licenseId], onDelete: Restrict, onUpdate: Restrict)
    licenseId             Int?
    lessonType            LessonType        @default(TRADITIONAL)
    selfRegulatedQuestion String?
    requires              Skill[]           @relation("requiredSkills")
    provides              Skill[]           @relation("providedSkills")

    lessonStart LearningDiaryLearnedLessons[]
}

model CompletedLesson {
    completedLessonId Int        @id @default(autoincrement())
    courseId          String?
    dynCourseId       String?
    lessonId          String
    username          String
    createdAt         DateTime   @default(now())
    performanceScore  Float      @default(0) // 0-1, 1 is perfect
    course            Course?    @relation(fields: [courseId], references: [courseId])
    dynCourse         DynCourse? @relation(fields: [dynCourseId], references: [courseId])
    lesson            Lesson     @relation(fields: [lessonId], references: [lessonId], onDelete: Cascade)
    user              Student    @relation(fields: [username], references: [username], onDelete: Cascade)

    @@index([username, lessonId])
}

model QuizAttempt {
    attemptId  String       @id @default(uuid())
    createdAt  DateTime     @default(now())
    state      String
    username   String
    lessonId   String
    QuizAnswer QuizAnswer[]
    lesson     Lesson       @relation(fields: [lessonId], references: [lessonId], onDelete: Cascade)
    student    Student      @relation(fields: [username], references: [username], onDelete: Cascade)

    @@index([username, lessonId])
}

model QuizAnswer {
    answerId      Int         @id @default(autoincrement())
    quizAttemptId String
    questionId    String
    answer        Json
    isCorrect     Boolean
    quizAttempt   QuizAttempt @relation(fields: [quizAttemptId], references: [attemptId], onDelete: Cascade)

    @@index([questionId])
}

enum EnrollmentStatus {
    ACTIVE
    INACTIVE
    COMPLETED
}
